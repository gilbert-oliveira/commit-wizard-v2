name: Deploy e Testes de Ambiente

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  BUN_VERSION: '1.0.0'

jobs:
  # Teste em Ambiente de Desenvolvimento
  test-dev:
    name: Teste em Dev
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Instalar dependÃªncias
        run: bun install

      - name: Build do projeto
        run: bun run build

      - name: Testar CLI em ambiente dev
        run: |
          echo "ğŸ§ª Testando CLI em ambiente de desenvolvimento..."

          # Testar ajuda
          timeout 5s bun run dist/commit-wizard.js --help || true

          # Testar versÃ£o
          timeout 5s bun run dist/commit-wizard.js --version || true

          # Testar com configuraÃ§Ã£o mÃ­nima
          echo '{"openai": {"apiKey": "test-key"}}' > .commit-wizardrc
          timeout 5s bun run dist/commit-wizard.js --dry-run || true

          echo "âœ… Testes de desenvolvimento concluÃ­dos"

  # Teste em Ambiente de Staging
  test-staging:
    name: Teste em Staging
    runs-on: ubuntu-latest
    needs: test-dev
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Instalar dependÃªncias
        run: bun install

      - name: Build do projeto
        run: bun run build

      - name: Simular instalaÃ§Ã£o global
        run: |
          echo "ğŸš€ Simulando instalaÃ§Ã£o global em staging..."

          # Criar diretÃ³rio de instalaÃ§Ã£o global
          sudo mkdir -p /usr/local/bin
          sudo cp dist/commit-wizard.js /usr/local/bin/commit-wizard
          sudo chmod +x /usr/local/bin/commit-wizard

          # Testar execuÃ§Ã£o global
          commit-wizard --help || true
          commit-wizard --version || true

          echo "âœ… Testes de staging concluÃ­dos"

  # Deploy para ProduÃ§Ã£o (apenas em main)
  deploy-prod:
    name: Deploy para ProduÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [test-dev, test-staging]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Instalar dependÃªncias
        run: bun install

      - name: Build do projeto
        run: bun run build

      - name: Verificar qualidade do build
        run: |
          echo "ğŸ” Verificando qualidade do build..."

          # Verificar se o arquivo principal existe
          if [ ! -f "dist/commit-wizard.js" ]; then
            echo "âŒ Arquivo principal nÃ£o encontrado"
            exit 1
          fi

          # Verificar permissÃµes
          chmod +x dist/commit-wizard.js

          # Verificar tamanho
          echo "ğŸ“¦ Tamanho do build:"
          ls -lh dist/

          # Testar execuÃ§Ã£o bÃ¡sica
          timeout 10s bun run dist/commit-wizard.js --help || true

          echo "âœ… Build verificado com sucesso"

      - name: Preparar para publicaÃ§Ã£o
        run: |
          echo "ğŸ“¦ Preparando pacote para publicaÃ§Ã£o..."

          # Criar arquivo de distribuiÃ§Ã£o
          mkdir -p release
          cp -r dist/ release/
          cp package.json README.md LICENSE .commit-wizardrc release/

          # Criar arquivo de checksum
          cd release && sha256sum * > checksums.txt

          echo "âœ… Pacote preparado"

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: commit-wizard-release
          path: release/
          retention-days: 30

  # Teste de Compatibilidade
  compatibility:
    name: Teste de Compatibilidade
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 21]
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Instalar dependÃªncias
        run: bun install

      - name: Executar testes bÃ¡sicos
        run: |
          echo "ğŸ§ª Testando compatibilidade com Node.js ${{ matrix.node-version }} no ${{ matrix.os }}"
          bun test --reporter=verbose

      - name: Testar build
        run: |
          echo "ğŸ”¨ Testando build..."
          bun run build

          # Verificar se o build funciona
          if [ -f "dist/commit-wizard.js" ]; then
            echo "âœ… Build bem-sucedido"
          else
            echo "âŒ Build falhou"
            exit 1
          fi

  # Teste de Performance
  performance-test:
    name: Teste de Performance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Instalar dependÃªncias
        run: bun install

      - name: Medir tempo de build
        run: |
          echo "âš¡ Medindo performance do build..."

          # Medir tempo de build
          start_time=$(date +%s)
          bun run build
          end_time=$(date +%s)

          build_time=$((end_time - start_time))
          echo "ğŸ• Tempo de build: ${build_time} segundos"

          # Verificar se estÃ¡ dentro do limite aceitÃ¡vel (30 segundos)
          if [ $build_time -gt 30 ]; then
            echo "âš ï¸  Build estÃ¡ lento (${build_time}s > 30s)"
          else
            echo "âœ… Build estÃ¡ dentro do limite aceitÃ¡vel"
          fi

      - name: Medir tempo de testes
        run: |
          echo "ğŸ§ª Medindo performance dos testes..."

          start_time=$(date +%s)
          bun test
          end_time=$(date +%s)

          test_time=$((end_time - start_time))
          echo "ğŸ• Tempo de testes: ${test_time} segundos"

          # Verificar se estÃ¡ dentro do limite aceitÃ¡vel (60 segundos)
          if [ $test_time -gt 60 ]; then
            echo "âš ï¸  Testes estÃ£o lentos (${test_time}s > 60s)"
          else
            echo "âœ… Testes estÃ£o dentro do limite aceitÃ¡vel"
          fi
